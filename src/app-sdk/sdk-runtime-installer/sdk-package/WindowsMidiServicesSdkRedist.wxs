<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

    <?define StagingSourceRootFolder=$(env.MIDI_REPO_ROOT)build\staging ?>

    
    
    <Package
          Name="Windows MIDI Services (App SDK Runtime) $(var.Platform)"
          Manufacturer="Microsoft Corporation"
          Version="1.0.0.0"
          UpgradeCode="297714bb-dd77-4748-a4c1-553ad66da5d0"
          >

        <MediaTemplate EmbedCab="yes" />


        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="ROOTINSTALLFOLDER" Name="Windows MIDI Services">
                <Directory Id="SDK_INSTALLROOT" Name="Desktop App SDK Runtime">
                    <Directory Id="SDK_x64_INSTALLFOLDER" Name="x64" />
                    <!--<Directory Id="SDK_Arm64_INSTALLFOLDER" Name="Arm64" />-->
                    <Directory Id="SDK_Arm64X_INSTALLFOLDER" Name="Arm64X" />
                </Directory>
                <Directory Id="TOOLSROOT_INSTALLFOLDER" Name="Tools">
                    <Directory Id="MIDIDIAG_INSTALLFOLDER" Name="Diagnostics" />
                    <Directory Id="MIDIUSB_INSTALLFOLDER" Name="UsbInfo" />
                </Directory>
            </Directory>
        </StandardDirectory>
        
        <!-- Install SDK -->

        <Component Id="WindowsMidiServicesAppSDK"
                   Bitness="always64"
                   Directory="SDK_x64_INSTALLFOLDER"
                   Guid="8016a59d-d844-4984-93e8-fa53f279abba">

            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\Microsoft.Windows.Devices.Midi2.dll" Vital="true" />
            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\Microsoft.Windows.Devices.Midi2.pri" />
            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\Microsoft.Windows.Devices.Midi2.winmd" Vital="true" />

            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\WindowsMidiServicesClientInitialization.dll" Vital="true" SelfRegCost="1"/>
            <!--<File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\WindowsMidiServicesClientInitialization.tlb" Vital="true"/>-->

        </Component>

        <!-- Install MIDI Diag Utility -->
        <Component Id="MidiDiagUtility"
                   Bitness="always64"
                   Directory="MIDIDIAG_INSTALLFOLDER"
                   Guid="a10cb6cb-571a-462e-9df7-f388460da50f"  >
            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\mididiag.exe" Vital="true" />

            <!-- Add folder to path -->
            <Environment Id="AddMidiDiagUtilityToSystemPath"
                            Name="PATH" Action="set" Part="last" System="yes"
                            Value="[MIDIDIAG_INSTALLFOLDER]" Permanent="no"/>
        </Component>

        <!-- Install MIDI USB Utility -->
        <Component Id="MidiUsbUtility"
                   Bitness="always64"
                   Directory="MIDIUSB_INSTALLFOLDER"
                   Guid="704c5cee-8af7-4826-a9b8-d45d14d24684"  >
            <File Source="$(StagingSourceRootFolder)\app-sdk\$(var.Platform)\midiusbinfo.exe" Vital="true" />

            <!-- Add folder to path -->
            <Environment Id="AddMidiUsbUtilityToSystemPath"
                            Name="PATH" Action="set" Part="last" System="yes"
                            Value="[MIDIUSB_INSTALLFOLDER]" Permanent="no"/>
        </Component>

        
        <!-- Add SDK Runtime folders to registry so that the SDK type resolver can find them -->
        <Component Id="WindowsMidiServicesAppSdkImplementationRegEntries"
                   Bitness="always64"
                   Directory="SDK_INSTALLROOT"
                   Guid="0ce8cde5-b1b8-4825-854d-c31427b91cb5">
            <RegistryKey Root="HKLM"
                         Key="SOFTWARE\Microsoft\Windows MIDI Services\Desktop App SDK Runtime">

                <!-- TODO: Need to only include what we actually install. Maybe simplify reg entries -->
                
                <RegistryValue Type="string" Name="x64"         Value="[SDK_x64_INSTALLFOLDER]" />
                <RegistryValue Type="string" Name="Arm64X"     Value="[SDK_Arm64X_INSTALLFOLDER]" />

            </RegistryKey>
        </Component>


        <Feature Id="WindowsMIDIServices">
            <ComponentRef Id="WindowsMidiServicesAppSDK" />
            <ComponentRef Id="WindowsMidiServicesAppSdkImplementationRegEntries"/>
            <ComponentRef Id="MidiDiagUtility"/>
            <ComponentRef Id="MidiUsbUtility"/>
        </Feature>

    </Package>
</Wix>
